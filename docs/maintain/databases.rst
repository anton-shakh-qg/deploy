Maintain PostgreSQL
===================

Troubleshoot
------------

Check the log file, ``/var/log/postgresql/postgresql-11-main.log``, if debugging an unscheduled restart of the ``postgres`` service, for example.

Control access
--------------

Service accounts
~~~~~~~~~~~~~~~~

Each service should have its own user, including:

-  Kingfisher Process
-  Kingfisher Summarize
-  Pelican
-  Redash

Tune settings
-------------

-  :doc:`Connect to the server<../use/ssh>`
-  Change to the ``postgres`` user:

   .. code-block:: bash

      su - postgres

Install postgresqltuner.sql
~~~~~~~~~~~~~~~~~~~~~~~~~~~

-  Download the ``postgresqltuner.sql`` file:

   .. code-block:: bash

      curl -O https://raw.githubusercontent.com/jfcoz/postgresqltuner/master/postgresqltuner.pl

-  Make the ``postgresqltuner.sql`` file executable:

   .. code-block:: bash

      chmod ug+x postgresqltuner.pl

Run postgresqltuner.sql
~~~~~~~~~~~~~~~~~~~~~~~

.. code-block:: bash

   ./postgresqltuner.sql --ssd

Under "Configuration advice", address "HIGH" and "MEDIUM" recommendations.

Reference: `Tuning Your PostgreSQL Server <https://wiki.postgresql.org/wiki/Tuning_Your_PostgreSQL_Server>`__

Reference: `Slow Query Questions <https://wiki.postgresql.org/wiki/Slow_Query_Questions>`__

Explore database
----------------

List databases:

.. code-block:: none

   \l

List schemas:

.. code-block:: none

   \dn

List tables, views and sequences in the ``public`` schema:

.. code-block:: none

   \d

List tables, indexes, views and sequences in the ``public`` schema:

.. code-block:: none

   \dtivs

To list tables, views and/or sequences in a specific schema, append, for example, ``views.*`` – or append ``*.*`` for all schema.

You can use the ``psql`` command's ``-E`` (``--echo-hidden``) `flag <https://www.postgresql.org/docs/current/app-psql.html#R1-APP-PSQL-3>`__ to echo the queries generated by the backslash commands.

Check disk usage
----------------

Get all database sizes:

.. code-block:: none

   \l+

Get all schema sizes:

.. code-block:: sql

   SELECT schema_name,
          schema_size,
          pg_size_pretty(schema_size),
          TRUNC(schema_size::numeric / pg_database_size(current_database()) * 100, 2) AS percent
   FROM (
     SELECT nspname AS schema_name,
            SUM(pg_relation_size(c.oid))::bigint AS schema_size
     FROM pg_class c
     JOIN pg_namespace n ON c.relnamespace = n.oid
     GROUP BY schema_name
   ) t
   ORDER BY schema_size DESC;

Get relation sizes in the ``public`` schema:

.. code-block:: none

   \dtis+

To get relation sizes in a specific schema, append, for example, ``views.*`` – or append ``*.*`` for all schema.

See the `Database Object Size Functions <https://www.postgresql.org/docs/current/functions-admin.html#FUNCTIONS-ADMIN-DBSIZE>`__ documentation.

.. _pg-stat-activity:

Show running queries
--------------------

Show running queries:

.. code-block:: sql

   SELECT pid, client_addr, usename, state, wait_event_type, NOW() - query_start AS time, query
   FROM pg_stat_activity
   WHERE query <> ''
   ORDER BY time DESC;

See the `pg_stat_activity <https://www.postgresql.org/docs/current/monitoring-stats.html#PG-STAT-ACTIVITY-VIEW>`__ table's documentation.

.. _pg-stat-all-tables:

Show autovacuum statistics
--------------------------

.. code-block:: sql

   SELECT nspname,
          s.relname,
          reltuples,
          n_live_tup::real,
          n_dead_tup::real,
          TRUNC(n_dead_tup / GREATEST(reltuples::numeric, 1) * 100, 2) AS percent,
          last_autovacuum,
          last_autoanalyze
   FROM pg_stat_all_tables s
   JOIN pg_class c ON relid = c.oid
   JOIN pg_namespace ON relnamespace = pg_namespace.oid
   ORDER BY percent DESC, last_autovacuum;

See the `pg_stat_all_tables <https://www.postgresql.org/docs/current/monitoring-stats.html#PG-STAT-ALL-TABLES-VIEW>`__ table's documentation.

To get the table related to a ``pg_toast_*`` table, take the number after ``pg_toast_``, and run, for example:

.. code-block:: sql

   SELECT '16712'::regclass;
