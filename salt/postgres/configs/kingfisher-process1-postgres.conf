#
# THIS FILE IS MANAGED BY SALT - DO NOT EDIT MANUALLY
#

listen_addresses = '*'
temp_buffers = 128MB

# https://github.com/jfcoz/postgresqltuner (BAD)
# https://www.postgresql.org/docs/current/runtime-config-query.html#GUC-ENABLE-PARTITIONWISE-AGGREGATE
enable_partitionwise_aggregate = on
# https://www.postgresql.org/docs/current/runtime-config-query.html#GUC-ENABLE-PARTITIONWISE-JOIN
enable_partitionwise_join = on

# https://github.com/jfcoz/postgresqltuner (WARN)
# https://www.postgresql.org/docs/current/runtime-config-resource.html#GUC-SHARED-BUFFERS
shared_buffers = {{ grains['mem_total'] // 4 }}MB # 25%
# https://www.postgresql.org/docs/13/runtime-config-query.html#GUC-EFFECTIVE-CACHE-SIZE
effective_cache_size = {{ grains['mem_total'] * 3 // 4 }}MB # 75%
# https://www.postgresql.org/docs/current/runtime-config-query.html#GUC-RANDOM-PAGE-COST
random_page_cost = 1.0 # SSD
# https://www.postgresql.org/docs/current/runtime-config-logging.html#GUC-LOG-MIN-DURATION-STATEMENT
log_min_duration_statement = 10000 # 10s
# https://www.postgresql.org/docs/current/pgstatstatements.html
shared_preload_libraries = 'pg_stat_statements'

# Caution: it is not advisable to set max_prepared_transactions nonzero unless
# you actively intend to use prepared transactions.
max_prepared_transactions = 100

work_mem = 10MB
maintenance_work_mem = 8GB
max_stack_depth = 6MB
bgwriter_delay = 100ms
effective_io_concurrency = 1000
max_parallel_workers_per_gather = 4

log_timezone = 'localtime'
timezone = 'localtime'

# For running multiple instances on one server
cluster_name = '10/main'
stats_temp_directory = '/var/run/postgresql/10-main.pg_stat_tmp'

# Replication settings for the primary server
wal_level = replica			# minimal, replica, or logical
					# (change requires restart)
synchronous_commit = local		# synchronization level;
					# off, local, remote_write, remote_apply, or on
max_wal_senders = 10			# max number of walsender processes
					# (change requires restart)
wal_keep_segments = 20			# minimum wal files stored, in logfile segments; 0 disables

fsync = on				# flush data to disk for crash safety
					# (turning this off can cause
					# unrecoverable data corruption)
synchronous_standby_names = 'pgslave001'	# standby servers that provide sync rep
						# method to choose sync standbys, number of sync standbys,
						# and comma-separated list of application_name
						# from standby(s); '*' = all
archive_mode = on			# enables archiving; off, on, or always
					# (change requires restart)
archive_command = 'cp %p /var/lib/postgresql/11/main/archive/%f'
					# command to use to archive a logfile segment
					# placeholders: %p = path of file to archive
					#               %f = file name only
max_wal_size = 10GB			# Increases stored wal limit in "11/main/pg_wal"
					# This directory is served out to replicas

wal_buffers = 16MB
wal_writer_delay = 1000ms
max_wal_senders = 10
max_replication_slots = 10
