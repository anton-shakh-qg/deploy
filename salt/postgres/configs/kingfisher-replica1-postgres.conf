#
# THIS FILE IS MANAGED BY SALT - DO NOT EDIT MANUALLY
#

listen_addresses = '*'
temp_buffers = 128MB

# https://github.com/jfcoz/postgresqltuner (BAD)
# https://www.postgresql.org/docs/current/runtime-config-query.html#GUC-ENABLE-PARTITIONWISE-AGGREGATE
enable_partitionwise_aggregate = on
# https://www.postgresql.org/docs/current/runtime-config-query.html#GUC-ENABLE-PARTITIONWISE-JOIN
enable_partitionwise_join = on

# https://github.com/jfcoz/postgresqltuner (WARN)
# https://www.postgresql.org/docs/current/runtime-config-resource.html#GUC-SHARED-BUFFERS
# https://wiki.postgresql.org/wiki/Tuning_Your_PostgreSQL_Server#shared_buffers
{#- NOTE: Remember to update vm.nr_hugepages in Pillar if this is changed. #}
shared_buffers = {{ grains['mem_total'] // 4 }}MB # 25%
# https://www.postgresql.org/docs/13/runtime-config-query.html#GUC-EFFECTIVE-CACHE-SIZE
# https://wiki.postgresql.org/wiki/Tuning_Your_PostgreSQL_Server#effective_cache_size
effective_cache_size = {{ grains['mem_total'] * 3 // 4 }}MB # 75%
# https://www.postgresql.org/docs/current/runtime-config-query.html#GUC-RANDOM-PAGE-COST
random_page_cost = 1.0 # SSD
# https://www.postgresql.org/docs/current/runtime-config-logging.html#GUC-LOG-MIN-DURATION-STATEMENT
log_min_duration_statement = 10000 # 10s
# https://www.postgresql.org/docs/current/pgstatstatements.html
shared_preload_libraries = 'pg_stat_statements'

# Caution: it is not advisable to set max_prepared_transactions nonzero unless
# you actively intend to use prepared transactions.
max_prepared_transactions = 100

# https://www.postgresql.org/docs/current/runtime-config-resource.html#GUC-WORK-MEM
# https://wiki.postgresql.org/wiki/Tuning_Your_PostgreSQL_Server#work_mem
work_mem = 10MB                     # default 4MB
# https://www.postgresql.org/docs/current/runtime-config-resource.html#GUC-MAINTENANCE-WORK-MEM
maintenance_work_mem = 8GB          # default 64MB
# https://www.postgresql.org/docs/current/runtime-config-resource.html#GUC-MAX-STACK-DEPTH
max_stack_depth = 6MB               # default 2MB
# https://www.postgresql.org/docs/current/runtime-config-resource.html#GUC-BGWRITER-DELAY
bgwriter_delay = 100ms              # default 200ms
# https://www.postgresql.org/docs/current/runtime-config-resource.html#GUC-EFFECTIVE-IO-CONCURRENCY
# "SSDs â€¦ can often process many concurrent requests, so the best value might be in the hundreds."
effective_io_concurrency = 1000     # default 1, 1-1000
# https://www.postgresql.org/docs/current/runtime-config-resource.html#GUC-MAX-PARALLEL-WORKERS-PER-GATHER
max_parallel_workers_per_gather = 4 # default 2

timezone = 'localtime'

log_timezone = 'localtime'

# For running multiple instances on one server
#cluster_name = '11/main'
#stats_temp_directory = '/var/run/postgresql/11-main.pg_stat_tmp'

# Replication settings for the replica server
wal_level = replica         # default logical (change requires restart)
synchronous_commit = local  # default on
wal_keep_segments = 10      # minimum wal files stored, in logfile segments; 0 disables

hot_standby = on            # "off" disallows queries during recovery (change requires restart)
